name: Power Platform Deployment Pipeline

on:
  workflow_dispatch: # allows manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 1: Install Power Platform CLI via .NET
    - name: Install Power Platform CLI via .NET
      shell: pwsh
      run: |
        dotnet tool install --global Microsoft.PowerApps.CLI.Tool
        $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
        pac

    # Step 2: Authenticate using Service Principal
    - name: Authenticate to Power Platform
      shell: pwsh
      run: |
        pac auth create --environment $env:PP_ENV_URL `
                        --applicationId $env:PP_APP_ID `
                        --clientSecret $env:PP_CLIENT_SECRET `
                        --tenant $env:PP_TENANT_ID
      env:
        PP_ENV_URL: ${{ secrets.PP_ENV_URL }}
        PP_APP_ID: ${{ secrets.PP_APP_ID }}
        PP_CLIENT_SECRET: ${{ secrets.PP_CLIENT_SECRET }}
        PP_TENANT_ID: ${{ secrets.PP_TENANT_ID }}

    
    # Step 3: Export solution from Dev
    - name: Export solutions from Dev
      shell: pwsh
      run: |
        $solutionName = "UnderwritingWorkbench"
        $exportPath = "$(Resolve-Path .)\Solutions\$solutionName.zip"
        pac solution export --name $solutionName --path $exportPath --managed false --overwrite
        Write-Host "Solution exported successfully from Dev!"


    # Step 3.4: Download and extract SolutionPackager.exe from NuGet
    - name: Download SolutionPackager.exe
      shell: pwsh
      run: |
        $toolsPath = "$(Resolve-Path .)\tools"
        if (!(Test-Path $toolsPath)) {
          New-Item -ItemType Directory -Path $toolsPath | Out-Null
        }

        $nugetUrl = "https://www.nuget.org/api/v2/package/Microsoft.CrmSdk.CoreTools"
        $downloadPath = "$toolsPath\CoreTools.nupkg"
        $extractPath = "$toolsPath\CoreTools"

        Invoke-WebRequest -Uri $nugetUrl -OutFile $downloadPath
        Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force

        $solutionPackagerPath = "$extractPath\content\bin\coretools\SolutionPackager.exe"
        if (!(Test-Path $solutionPackagerPath)) {
          throw "❌ SolutionPackager.exe not found after extraction."
        }

        Write-Host "✅ SolutionPackager.exe downloaded to $solutionPackagerPath"


    # Step 3.5: Unpack solution before validation
    - name: Unpack solution using SolutionPackager
      shell: pwsh
      run: |
        $solutionZip = "$(Resolve-Path .)\Solutions\UnderwritingWorkbench.zip"
        $unpackPath = "$(Resolve-Path .)\UnpackedSolution"
        $solutionPackagerPath = "$(Resolve-Path .)\tools\CoreTools\content\bin\coretools\SolutionPackager.exe"
        
        if (!(Test-Path $solutionPackagerPath)) {
          throw "SolutionPackager.exe not found at $solutionPackagerPath"
        }

        & $solutionPackagerPath /action:Extract /zipfile:$solutionZip /folder:$unpackPath /packagetype:Unmanaged
        Write-Host "✅ Solution unpacked to $unpackPath"

    # Step 4: Run Best Practice Validation
    - name: Run Best Practice Validation
      shell: pwsh
      run: |
        $solutionPath = "$(Resolve-Path .)\UnpackedSolution"
        $solutionZip = "$(Resolve-Path .)\Solutions\UnderwritingWorkbench.zip"
        $solutionPackagerPath = "$(Resolve-Path .)\tools\SolutionPackager.exe"

        pwsh ./scripts/validate-solution.ps1 `
          -solutionPath $solutionPath `
          -solutionZip $solutionZip `
          -solutionPackagerPath $solutionPackagerPath

    # Step 5: Import solution to Test
    - name: Import solution to Test
      if: success()
      shell: pwsh
      run: |
        pac auth create --environment $env:PP_ENV_URL `
                        --applicationId $env:PP_APP_ID `
                        --clientSecret $env:PP_CLIENT_SECRET `
                        --tenant $env:PP_TENANT_ID
        $solutionName = "UnderwritingWorkbenchTarget"
        $solutionZip = "$(Resolve-Path .)\Solutions\$solutionName.zip"
        pac solution import --path $solutionZip --overwrite --publish-changes
        Write-Host "Successfully deployed to Test environment."
      env:
        PP_ENV_URL: ${{ secrets.PP_ENV_URL }}
        PP_APP_ID: ${{ secrets.PP_APP_ID }}
        PP_CLIENT_SECRET: ${{ secrets.PP_CLIENT_SECRET }}
        PP_TENANT_ID: ${{ secrets.PP_TENANT_ID }}
