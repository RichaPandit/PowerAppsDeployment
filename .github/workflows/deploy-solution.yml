name: Power Platform Deployment Pipeline

on:
  workflow_dispatch: # allows manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 1: Install Power Platform CLI via .NET
    - name: Install Power Platform CLI via .NET
      shell: pwsh
      run: |
        dotnet tool install --global Microsoft.PowerApps.CLI.Tool
        $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
        pac
        
    # Step 1: Export solution from Dev
    - name: Export solutions from Dev
      shell: pwsh
      run: |
        pac auth create --url $env:PP_ENV_URL --username $env:PP_USERNAME --password $env:PP_PASSWORD
        pac org select --name DevEnv
        pac solution export --name UnderwritingWorkbench --path Solutions/UnderwritingWorkbench.zip --managed false --overwrite
      env:
        PP_ENV_URL: ${{ secrets.PP_ENV_URL }}
        PP_USERNAME: ${{ secrets.PP_USERNAME }}
        PP_PASSWORD: ${{ secrets.PP_PASSWORD }}

    # Step 5: Run Best Practice Validation
    - name: Run Best Practice Validation
      shell: pwsh
      run: |
        pwsh ./scripts/validate-solution.ps1 -solutionPath .\UnpackedSolution

    # Step 6: Authentictate to Test Environment (only if all previous steps pass)
    - name: Import solution to Test
      if: success()
      uses: microsoft/powerplatform-actions/import-solution@v1
      with:
        environment-url: ${{ secrets.PP_ENV_URL  }}
        user-name: ${{ secrets.PP_USERNAME  }}
        password-secret: ${{ secrets.PP_PASSWORD  }}
        solution-input-file: UnderwritingWorkbenchTarget.zip
        overwrite-unmanaged-customizations: true
        publish-changes: true
