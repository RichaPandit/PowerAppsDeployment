name: Power Platform Deployment Pipeline

on:
  workflow_dispatch: # allows manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Power Platform CLI
      shell: pwsh
      run: |
        Write-Host "Downloading PAC CLI..."
        Invoke-WebRequest -Uri https://aka.ms/PowerAppsCLI.msi -OutFile PowerApps.msi
        Write-Host "Installing PAC CLI..."
        Start-Process msiexec.exe -Wait -ArgumentList '/i PowerAppsCLI.msi /quiet'
        Write-Host "Locating PAC CLI..."
        $pacExe = & where.exe pac
        if ($pacExe)
          {
            Write-Host "PAC CLI installed successfully."
            & $pacExe --version
          } else {
            Write-Error "PAC CLI not found at $pacExe"
            exit 1
          }

    # Step 0: Authenticate to DEV environment
    - name: Authenticate with Power Platform
      shell: pwsh
      run: |
        $pacExe = "C:\Program Files\Power Platform Tools\pac.exe"
        & $pacExe auth create --url $env:PP_ENV_URL --username $nev:PP_USERNAME --password $env:PP_PASSWORD
        & $pacExe org select --name DevEnv
      env:
        PP_ENV_URL: ${{ secrets.PP_ENV_URL  }}
        PP_USERNAME: ${{ secrets.PP_USERNAME  }}
        PP_PASSWORD: ${{ secrets.PP_PASSWORD  }}

    # Step 1: Export solution from Dev
    - name: Export solutions from Dev
      shell: pwsh
      run: |
        $solutionName = "UnderwritingWorkbench"
        $exportPath = "$(Resolve-Path .)\Solutions\$solutionName.zip"
        pac solution export --name $solutionName --path $exportPath --managed false --overwrite
        Write-Host "Solution exported successfully from Dev!"

    # Step 5: Run your custom validation script
    - name: Run Best Practice Validation
      shell: pwsh
      run: |
        pwsh ./scripts/validate-solution.ps1 -solutionPath .\UnpackedSolution

    # Step 6: Deploy to Test (only if all previous steps pass)
    - name: Deploy to Test
      if: success()
      shell: pwsh
      run: |
        pac auth create --url $env:PP_ENV_URL --username $nev:PP_USERNAME --password $env:PP_PASSWORD
        pac org select --name TestEnv
        $solutionName = "UnderwritingWorkbenchTarget"
        $solutionZip = "$(Resolve-Path .)\Solutions\$solutionName.zip"
        pac solution import --path $solutionZip --overwrite --publish-changes
        Write-Host "Successfully deployed to Test environment."
      env:
        PP_ENV_URL: ${{ secrets.PP_ENV_URL  }}
        PP_USERNAME: ${{ secrets.PP_USERNAME  }}
        PP_PASSWORD: ${{ secrets.PP_PASSWORD  }}